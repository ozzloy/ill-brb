* test csrf tokens

#+begin_quote
$ wget \
  localhost:8000/api/csrf/restore \
  |jq "."
  HTTP/1.1 200 OK
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Set-Cookie: _csrf=RYf3m1rhk8d3M_kIpDX5yEy7; Path=/; HttpOnly
  Set-Cookie: XSRF-TOKEN=N8MIUJxU-JpMmXFkLhllv9BP8j4OCM8rL7VY; Path=/
  Content-Type: application/json; charset=utf-8
  Content-Length: 53
  ETag: W/"35-AhfVMa7YzOf2bUgBoj3ys2I5zr8"
  Date: Thu, 31 Oct 2024 04:25:55 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{
  "XSRF-Token": "N8MIUJxU-JpMmXFkLhllv9BP8j4OCM8rL7VY"
}

$ wget \
  localhost:8000/api/test \
  --post-data='{"hello":"world"}' \
  --header="Content-Type: application/json" \
  --header="XSRF-TOKEN: N8MIUJxU-JpMmXFkLhllv9BP8j4OCM8rL7VY" \
  --header="Cookie: _csrf=RYf3m1rhk8d3M_kIpDX5yEy7; XSRF-TOKEN=N8MIUJxU-JpMmXFkLhllv9BP8j4OCM8rL7VY" \
  | jq "."
  HTTP/1.1 200 OK
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Content-Type: application/json; charset=utf-8
  Content-Length: 33
  ETag: W/"21-Af/1Tl4sZsEccqgKMljFWEmvsJ8"
  Date: Thu, 31 Oct 2024 04:27:19 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{
  "requestBody": {
    "hello": "world"
  }
}
#+end_quote

* test jwt session persistence
#+begin_quote
# create cookie for jwt (also csrf, but that's not what's being tested)
$ wget \
> http://localhost:8000/api/set-token-cookie \
> | jq "."
  HTTP/1.1 200 OK
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Set-Cookie: _csrf=0fq7rZnQsC6ygwkvWzb8YvTY; Path=/; HttpOnly
  Set-Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjoxLCJ1c2VybmFtZSI6IkRlbW8tbGl0aW9uIn0sImlhdCI6MTczMDQwODUyOCwiZXhwIjoxNzMxMDEzMzI4fQ.iRnHDkU-H3jB0EV-hT-nX3aqcP_1ctLFGwNXJdylS0k; Max-Age=604800; Path=/; Expires=Thu, 07 Nov 2024 21:02:08 GMT; HttpOnly
  Content-Type: application/json; charset=utf-8
  Content-Length: 42
  ETag: W/"2a-1pZ1p97mMwN3w5Wt5ukYRivp8T0"
  Date: Thu, 31 Oct 2024 21:02:08 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{
  "user": {
    "id": 1,
    "username": "Demo-lition"
  }
}

# good request
$ wget \
> http://localhost:8000/api/restore-user \
> --header="Cookie: _csrf=0fq7rZnQsC6ygwkvWzb8YvTY; token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjoxLCJ1c2VybmFtZSI6IkRlbW8tbGl0aW9uIn0sImlhdCI6MTczMDQwODUyOCwiZXhwIjoxNzMxMDEzMzI4fQ.iRnHDkU-H3jB0EV-hT-nX3aqcP_1ctLFGwNXJdylS0k" \
> | jq "."
  HTTP/1.1 200 OK
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Content-Type: application/json; charset=utf-8
  Content-Length: 138
  ETag: W/"8a-1c4brGMElzrZ55Pim/I/6adIG7k"
  Date: Thu, 31 Oct 2024 21:06:29 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{
  "id": 1,
  "username": "Demo-lition",
  "email": "demo@example.com",
  "createdAt": "2024-10-31T19:53:01.465Z",
  "updatedAt": "2024-10-31T19:53:01.465Z"
}

# bad request, jwt token is bad
$ wget \
> http://localhost:8000/api/restore-user \
> --header="Cookie: _csrf=0fq7rZnQsC6ygwkvWzb8YvTY; token=bad.jwt.token" \
> | jq "."
  HTTP/1.1 200 OK
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Content-Type: application/json; charset=utf-8
  Content-Length: 4
  ETag: W/"4-K+iMpCQsduglOsYkdIUQZQMtaDM"
  Date: Thu, 31 Oct 2024 21:31:26 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
null
#+end_quote

* test requireAuth middleware
#+begin_quote
# set new token cookie
$ wget \
> http://localhost:8000/api/set-token-cookie \
> | jq "."
  HTTP/1.1 200 OK
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Set-Cookie: _csrf=E4u1QIkRx-BdKZRcajR0JRBR; Path=/; HttpOnly
  Set-Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjoxLCJ1c2VybmFtZSI6IkRlbW8tbGl0aW9uIn0sImlhdCI6MTczMDQxMDU3MywiZXhwIjoxNzMxMDE1MzczfQ.sprKDmAykeC9lwqlM5nW3IiymCnrj_unRAQoQXvekhE; Max-Age=604800; Path=/; Expires=Thu, 07 Nov 2024 21:36:13 GMT; HttpOnly
  Content-Type: application/json; charset=utf-8
  Content-Length: 42
  ETag: W/"2a-1pZ1p97mMwN3w5Wt5ukYRivp8T0"
  Date: Thu, 31 Oct 2024 21:36:13 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{
  "user": {
    "id": 1,
    "username": "Demo-lition"
  }
}

# do a get with authorization cookie set
$ wget \
> http://localhost:8000/api/require-auth \
> --header="Cookie: _csrf=E4u1QIkRx-BdKZRcajR0JRBR; token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjoxLCJ1c2VybmFtZSI6IkRlbW8tbGl0aW9uIn0sImlhdCI6MTczMDQxMDU3MywiZXhwIjoxNzMxMDE1MzczfQ.sprKDmAykeC9lwqlM5nW3IiymCnrj_unRAQoQXvekhE" \
> | jq "."
  HTTP/1.1 200 OK
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Content-Type: application/json; charset=utf-8
  Content-Length: 138
  ETag: W/"8a-1c4brGMElzrZ55Pim/I/6adIG7k"
  Date: Thu, 31 Oct 2024 21:37:47 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{
  "id": 1,
  "username": "Demo-lition",
  "email": "demo@example.com",
  "createdAt": "2024-10-31T19:53:01.465Z",
  "updatedAt": "2024-10-31T19:53:01.465Z"
}

# do a get without authorization cookie set
$ wget \
> http://localhost:8000/api/require-auth \
> --header="Cookie: _csrf=E4u1QIkRx-BdKZRcajR0JRBR;" \
> | jq "."
  HTTP/1.1 401 Unauthorized
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Content-Type: application/json; charset=utf-8
  Content-Length: 1295
  ETag: W/"50f-5KeKBRVjT0TQo2LwRSeguh5NGUY"
  Date: Thu, 31 Oct 2024 21:38:16 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
#+end_quote

* test login

browse to http://localhost:8000/api/csrf/restore

get XSRF-Token: 9tfXLRm4-7qtVi1UUHVWm4FGqcTocs7LxGtQ

#+begin_src js
  const xsrfToken = "9tfXLRm4-7qtVi1UUHVWm4FGqcTocs7LxGtQ";
  const foo = await fetch('/api/session', {
    method: 'POST',
    headers: {
      "Content-Type": "application/json",
      "XSRF-TOKEN": xsrfToken,
    },
    body: JSON.stringify({ credential: 'Demo-lition', password: 'password' })
  })
  const bar = await foo.json();
  console.log(bar);
#+end_src

#+begin_quote
$ wget http://localhost:8000/api/csrf/restore | jq "."
  HTTP/1.1 200 OK
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Set-Cookie: _csrf=Eqqiv95WWUKkT-TN3w_LLq8B; Path=/; HttpOnly
  Set-Cookie: XSRF-TOKEN=fhnig0Wt-5oH7lyh7c5ZOV2ZWuxQl8SKctlc; Path=/
  Content-Type: application/json; charset=utf-8
  Content-Length: 53
  ETag: W/"35-IIkgCdIsuzhDSgTzh6saq8FyjAw"
  Date: Thu, 31 Oct 2024 23:08:49 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{
  "XSRF-Token": "fhnig0Wt-5oH7lyh7c5ZOV2ZWuxQl8SKctlc"
}

# no csrf token cookie
$ wget \
> "http://localhost:8000/api/session" \
> --post-data="{\"credential\":\"Demo-lition\",\"password\":\"password\"}"
  HTTP/1.1 403 Forbidden
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  set-cookie: _csrf=FaPiUZCkyAbJ4C1_FXNTr4VE; Path=/; HttpOnly
  Content-Type: application/json; charset=utf-8
  Content-Length: 1260
  ETag: W/"4ec-Srf6qQ43P56aTOOoqAshFiP4O5s"
  Date: Thu, 31 Oct 2024 23:10:11 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{"title":"Server Error","message":"invalid csrf token","stack":"ForbiddenError: invalid csrf token\n    at csrf (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/csurf/index.js:112:19)\n    at newFn (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express-async-errors/index.js:16:20)\n    at Layer.handle [as handle_request] (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/index.js:328:13)\n    at /home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/index.js:346:12)\n    at next (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/index.js:280:10)\n    at crossOriginResourcePolicyMiddleware (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/helmet/index.cjs:171:3)\n    at newFn (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express-async-errors/index.js:16:20)\n    at Layer.handle [as handle_request] (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/layer.js:95:5)"}ozzloy@trent-reznor:~/app-academy/src/ill-brb/backend$ 

# no xsrf header
$ wget \
> "http://localhost:8000/api/session" \
> --post-data="{\"credential\":\"Demo-lition\",\"password\":\"password\"}" \
> --header="Cookie: _csrf=Eqqiv95WWUKkT-TN3w_LLq8B; XSRF-TOKEN=fhnig0Wt-5oH7lyh7c5ZOV2ZWuxQl8SKctlc;" \
> | jq "."
  HTTP/1.1 403 Forbidden
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Content-Type: application/json; charset=utf-8
  Content-Length: 1260
  ETag: W/"4ec-Srf6qQ43P56aTOOoqAshFiP4O5s"
  Date: Thu, 31 Oct 2024 23:12:47 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{
  "title": "Server Error",
  "message": "invalid csrf token",
  "stack": "ForbiddenError: invalid csrf token\n    at csrf (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/csurf/index.js:112:19)\n    at newFn (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express-async-errors/index.js:16:20)\n    at Layer.handle [as handle_request] (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/layer.js:95:5)\n    at trim_prefix (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/index.js:328:13)\n    at /home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/index.js:286:9\n    at Function.process_params (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/index.js:346:12)\n    at next (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/index.js:280:10)\n    at crossOriginResourcePolicyMiddleware (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/helmet/index.cjs:171:3)\n    at newFn (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express-async-errors/index.js:16:20)\n    at Layer.handle [as handle_request] (/home/ozzloy/app-academy/src/ill-brb/backend/node_modules/express/lib/router/layer.js:95:5)"
}

# correct.  has XSRF-TOKEN header, csrf cookie, and xsrf cookie
ozzloy@trent-reznor:~/app-academy/src/ill-brb/backend$ wget \
> "http://localhost:8000/api/session" \
> --post-data="{\"credential\":\"Demo-lition\",\"password\":\"password\"}" \
> --header="Content-Type: application/json" \
> --header="XSRF-TOKEN: fhnig0Wt-5oH7lyh7c5ZOV2ZWuxQl8SKctlc" \
> --header="Cookie: _csrf=Eqqiv95WWUKkT-TN3w_LLq8B; XSRF-TOKEN=fhnig0Wt-5oH7lyh7c5ZOV2ZWuxQl8SKctlc;" \
> | jq "."
  HTTP/1.1 200 OK
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Set-Cookie: token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJkYXRhIjp7ImlkIjoxLCJlbWFpbCI6ImRlbW9AZXhhbXBsZS5jb20iLCJ1c2VybmFtZSI6IkRlbW8tbGl0aW9uIn0sImlhdCI6MTczMDQxNjUxMCwiZXhwIjoxNzMxMDIxMzEwfQ.gwc35YYbSIrZRaud3P8C6e4SDX9aDfD3D8P6yssLaCQ; Max-Age=604800; Path=/; Expires=Thu, 07 Nov 2024 23:15:10 GMT; HttpOnly
  Content-Type: application/json; charset=utf-8
  Content-Length: 69
  ETag: W/"45-u2OQyG56y80snQbKitSlZ5nJ6Cw"
  Date: Thu, 31 Oct 2024 23:15:10 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{
  "user": {
    "id": 1,
    "email": "demo@example.com",
    "username": "Demo-lition"
  }
}

# incorrect password
$ wget \
> "http://localhost:8000/api/session" \
> --post-data="{\"credential\":\"demo@example.com\",\"password\":\"wrong password\"}" \
> --header="Content-Type: application/json" \
> --header="XSRF-TOKEN: fhnig0Wt-5oH7lyh7c5ZOV2ZWuxQl8SKctlc" \
> --header="Cookie: _csrf=Eqqiv95WWUKkT-TN3w_LLq8B; XSRF-TOKEN=fhnig0Wt-5oH7lyh7c5ZOV2ZWuxQl8SKctlc;" \
> | jq "."
  HTTP/1.1 401 Unauthorized
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Content-Type: application/json; charset=utf-8
  Content-Length: 225
  ETag: W/"e1-yhw9pDN/jIkKa95BOMBsUTOBcas"
  Date: Fri, 01 Nov 2024 01:28:01 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
#+end_quote

* logout test
#+begin_quote
# create session tokens
$ wget http://localhost:8000/api/csrf/restore | jq "."
  HTTP/1.1 200 OK
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Set-Cookie: _csrf=TSDi7OpXnqd4nL9n7AyHOwYB; Path=/; HttpOnly
  Set-Cookie: XSRF-TOKEN=peWe99qx-J0d0rJjs7ECyRyrmXvQiVDghvaE; Path=/
  Content-Type: application/json; charset=utf-8
  Content-Length: 53
  ETag: W/"35-HXPzTKVDxK037yZSThAUq4UYJ3M"
  Date: Fri, 01 Nov 2024 01:33:54 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{
  "XSRF-Token": "peWe99qx-J0d0rJjs7ECyRyrmXvQiVDghvaE"
}

# log out
$ wget \
> http://localhost:8000/api/session \
> --method=DELETE \
> --header="XSRF-TOKEN: peWe99qx-J0d0rJjs7ECyRyrmXvQiVDghvaE" \
> --header="Cookie: _csrf=TSDi7OpXnqd4nL9n7AyHOwYB; XSRF-TOKEN=peWe99qx-J0d0rJjs7ECyRyrmXvQiVDghvaE;" \
> | jq "."
  HTTP/1.1 200 OK
  X-Powered-By: Express
  Access-Control-Allow-Origin: *
  Cross-Origin-Resource-Policy: cross-origin
  Set-Cookie: token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT
  Content-Type: application/json; charset=utf-8
  Content-Length: 21
  ETag: W/"15-ga8EF/lp+ThIsc8w/OHbk4hPrME"
  Date: Fri, 01 Nov 2024 01:37:49 GMT
  Connection: keep-alive
  Keep-Alive: timeout=5
{
  "message": "success"
}
#+end_quote
